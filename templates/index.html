<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Prediction AI</title>
    
    <!-- External Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .form-select {
            border-radius: 5px;
        }
        .btn-primary {
            border-radius: 5px;
            padding: 8px 20px;
            font-weight: bold;
        }
        .metric-card {
            text-align: center;
            padding: 15px;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
        }
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .result-table th {
            background-color: #f1f8ff;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .date-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .date-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
        }
        .date-item:last-child {
            border-bottom: none;
        }
        #resultsSection {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem; 
            height: 3rem;
        }
        .kaggle-info {
            background-color: #20beff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Stock Prediction AI</a>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container mt-4">
        <div class="row">
            <!-- Left Column: Input Controls -->
            <div class="col-md-4">
                <!-- Prediction Parameters Card -->
                <div class="card">
                    <div class="card-header">
                        Stock Prediction Parameters
                    </div>
                    <div class="card-body">
                        <form id="predictionForm">
                            <!-- Stock Selection -->
                            <div class="mb-3">
                                <label for="stockSelect" class="form-label">Stock File</label>
                                <select class="form-select" id="stockSelect">
                                    <option value="AAL" selected>AAL - American Airlines</option>
                                    <option value="AAPL">AAPL - Apple Inc.</option>
                                    <option value="MSFT">MSFT - Microsoft</option>
                                    <option value="GOOGL">GOOGL - Alphabet</option>
                                    <option value="AMZN">AMZN - Amazon</option>
                                </select>
                            </div>
                            
                            <!-- Algorithm Selection -->
                            <div class="mb-3">
                                <label for="algorithmSelect" class="form-label">ML Algorithm</label>
                                <select class="form-select" id="algorithmSelect">
                                    <option value="random_forest" selected>Random Forest</option>
                                    <option value="linear_regression">Linear Regression</option>
                                    <option value="svr">Support Vector Regression</option>
                                </select>
                            </div>
                            
                            <!-- Data Period Selection -->
                            <div class="mb-3">
                                <label for="periodSelect" class="form-label">Data Period</label>
                                <select class="form-select" id="periodSelect">
                                    <option value="1mo" selected>1 Month</option>
                                    <option value="3mo">3 Months</option>
                                    <option value="6mo">6 Months</option>
                                    <option value="1y">1 Year</option>
                                    <option value="2y">2 Years</option>
                                </select>
                            </div>
                            
                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary w-100">Fetch Data & Predict</button>
                        </form>
                        
                        <!-- Data Source Info -->
                        <div class="kaggle-info">
                            <strong>Data Source:</strong> Yahoo Finance API
                        </div>
                    </div>
                </div>

                <!-- Decision Boundaries Card -->
                <div class="card mt-4">
                    <div class="card-header">
                        Decision Boundaries
                    </div>
                    <div class="card-body">
                        <!-- Data Statistics -->
                        <div class="mb-3">
                            <strong>Data Points: </strong><span id="dataCount">0</span>
                        </div>
                        <div>
                            <strong>Training Points: </strong><span id="trainingCount">0</span>
                        </div>
                        
                        <!-- Recent Dates List -->
                        <div class="mt-3">
                            <strong>Recent Dates:</strong>
                            <div class="date-list" id="dateList">
                                <!-- Dates will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results Display -->
            <div class="col-md-8">
                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Fetching data and training model...</p>
                </div>

                <!-- Results Section (Initially Hidden) -->
                <div id="resultsSection">
                    <!-- Model Evaluation Card -->
                    <div class="card">
                        <div class="card-header">
                            Model Evaluation
                        </div>
                        <div class="card-body">
                            <p>The following table shows the Mean Squared Error (MSE) for the model. The lower the value, the better it is.</p>
                            
                            <h5>Test Evaluation</h5>
                            <table class="result-table table">
                                <thead>
                                    <tr>
                                        <th>Model</th>
                                        <th>Mean Squared Error (MSE)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="modelName">Random Forest</td>
                                        <td id="mseValue">0.0000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Prediction Results Card -->
                    <div class="card mt-4">
                        <div class="card-header">
                            Prediction Results
                        </div>
                        <div class="card-body">
                            <p>The following table shows the original opening value of stock along with its predicted opening value for the next trading day.</p>
                            
                            <h5>Predictions</h5>
                            <table class="result-table table">
                                <thead>
                                    <tr>
                                        <th>Model</th>
                                        <th>Opening Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Last Actual Opening Price</td>
                                        <td id="originalValue">.00</td>
                                    </tr>
                                    <tr>
                                        <td id="predictionModel">Random Forest</td>
                                        <td id="predictionValue">.00</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Chart Container -->
                            <div class="chart-container">
                                <canvas id="predictionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Cards -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card metric-card">
                                <div class="metric-value" id="accuracyValue">0.0%</div>
                                <div class="metric-label">Prediction Accuracy</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card metric-card">
                                <div class="metric-value" id="errorValue">0.0%</div>
                                <div class="metric-label">Average Error</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // Global chart instance
        let predictionChart;
        
        /**
         * Initialize the Chart.js line chart for visualizing predictions.
         * Creates a dual-line chart for actual vs predicted prices.
         */
        function initializeChart() {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],  // Dates will be populated
                    datasets: [
                        {
                            label: 'Actual Opening Price',
                            data: [],  // Actual prices
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Predicted Opening Price',
                            data: [],  // Predicted prices
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: true,
                            borderDash: [5, 5]  // Dashed line for predictions
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Actual vs Predicted Stock Prices'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Handle form submission to fetch predictions from the backend API.
         * Shows loading indicator, makes POST request, and updates UI with results.
         * Includes fallback to simulated data if API request fails.
         */
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get user selections
            const stock = document.getElementById('stockSelect').value;
            const algorithm = document.getElementById('algorithmSelect').value;
            const period = document.getElementById('periodSelect').value;
            
            // Show loading, hide results
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            try {
                // Make API request to Flask backend
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock: stock,
                        algorithm: algorithm,
                        period: period
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                // Process successful response
                const result = await response.json();
                updateUIWithResults(result);
                
            } catch (error) {
                // Fallback to simulated data on error
                console.error('Error:', error);
                simulatePrediction(stock, algorithm);
            } finally {
                // Hide loading, show results
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
            }
        });

        /**
         * Update the UI with prediction results from the backend.
         * Updates all display elements with real data from the API response.
         * 
         * @param {Object} result - Prediction results from Flask API
         */
        function updateUIWithResults(result) {
            // Update model evaluation
            document.getElementById('modelName').textContent = result.model;
            document.getElementById('mseValue').textContent = result.mse.toFixed(6);
            
            // Update price predictions
            document.getElementById('originalValue').textContent = '$' + result.last_actual_open.toFixed(2);
            document.getElementById('predictionValue').textContent = '$' + result.next_day_prediction.toFixed(2);
            document.getElementById('predictionModel').textContent = result.model;
            
            // Update chart with new data
            predictionChart.data.labels = result.dates;
            predictionChart.data.datasets[0].data = result.actual_prices;
            predictionChart.data.datasets[1].data = result.predicted_prices;
            predictionChart.update();
            
            // Calculate and display accuracy metrics
            const accuracy = 100 - (result.mse / result.last_actual_open * 100);
            document.getElementById('accuracyValue').textContent = accuracy.toFixed(1) + '%';
            document.getElementById('errorValue').textContent = (result.mse / result.last_actual_open * 100).toFixed(1) + '%';
            
            // Update data statistics
            document.getElementById('dataCount').textContent = result.data_points;
            document.getElementById('trainingCount').textContent = result.training_points;
            
            // Update recent dates list
            const dateList = document.getElementById('dateList');
            dateList.innerHTML = '';
            
            result.recent_dates.forEach(date => {
                const dateItem = document.createElement('div');
                dateItem.className = 'date-item';
                dateItem.textContent = date;
                dateList.appendChild(dateItem);
            });
        }

        /**
         * Generate simulated prediction data for demonstration or fallback.
         * Creates realistic-looking data when backend API is unavailable.
         * 
         * @param {string} stock - Selected stock symbol
         * @param {string} algorithm - Selected ML algorithm
         */
        function simulatePrediction(stock, algorithm) {
            // Get model display name
            const modelName = document.getElementById('algorithmSelect').options[document.getElementById('algorithmSelect').selectedIndex].text;
            
            // Update model info with simulated data
            document.getElementById('modelName').textContent = modelName;
            document.getElementById('mseValue').textContent = (0.4 + Math.random() * 0.1).toFixed(6);
            
            // Generate simulated prices
            const originalPrice = (100 + Math.random() * 20).toFixed(2);
            const predictedPrice = (originalPrice * (0.97 + Math.random() * 0.06)).toFixed(2);
            
            document.getElementById('originalValue').textContent = '$' + originalPrice;
            document.getElementById('predictionValue').textContent = '$' + predictedPrice;
            document.getElementById('predictionModel').textContent = modelName;
            
            // Generate dates for last 8 days
            const today = new Date();
            const dates = [];
            for (let i = 7; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            // Generate simulated price data
            const newActualData = Array.from({length: 8}, () => 100 + Math.random() * 15);
            const newPredictedData = newActualData.map(value => value * (0.97 + Math.random() * 0.06));
            
            // Update chart with simulated data
            predictionChart.data.labels = dates;
            predictionChart.data.datasets[0].data = newActualData;
            predictionChart.data.datasets[1].data = newPredictedData;
            predictionChart.update();
            
            // Generate simulated metrics
            const accuracy = (90 + Math.random() * 8).toFixed(1);
            const error = (1.5 + Math.random() * 1.5).toFixed(1);
            
            document.getElementById('accuracyValue').textContent = accuracy + '%';
            document.getElementById('errorValue').textContent = error + '%';
            
            // Update data statistics
            document.getElementById('dataCount').textContent = Math.floor(100 + Math.random() * 50);
            document.getElementById('trainingCount').textContent = Math.floor(90 + Math.random() * 40);
            
            // Generate recent dates list
            const dateList = document.getElementById('dateList');
            dateList.innerHTML = '';
            
            for (let i = 9; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateItem = document.createElement('div');
                dateItem.className = 'date-item';
                dateItem.textContent = date.toISOString().split('T')[0];
                dateList.appendChild(dateItem);
            }
        }

        // Initialize chart when page loads
        window.onload = function() {
            initializeChart();
        };
    </script>
</body>
</html>